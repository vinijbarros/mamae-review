name: Backup Firestore Di√°rio

on:
  schedule:
    # Executar todo dia √†s 02:00 UTC (23:00 hor√°rio de Bras√≠lia)
    - cron: '0 2 * * *'
  
  # Permitir execu√ß√£o manual
  workflow_dispatch:

jobs:
  backup:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: mamae-review/package-lock.json
      
      - name: Instalar depend√™ncias
        working-directory: mamae-review
        run: npm ci
      
      - name: Configurar credenciais do Firebase
        working-directory: mamae-review
        run: |
          echo "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" > service-account.json
          echo "FIREBASE_SERVICE_ACCOUNT_PATH=./service-account.json" >> .env.local
          echo "NEXT_PUBLIC_FIREBASE_PROJECT_ID=${{ secrets.NEXT_PUBLIC_FIREBASE_PROJECT_ID }}" >> .env.local
      
      - name: Executar backup
        working-directory: mamae-review
        run: npx tsx scripts/backupFirestore.ts
      
      - name: Remover credenciais
        working-directory: mamae-review
        run: rm -f service-account.json .env.local
      
      - name: Configurar Git
        run: |
          git config --global user.name "Backup Bot"
          git config --global user.email "bot@mamaereview.com"
      
      - name: Commit e Push do backup
        run: |
          DATE=$(date +%Y-%m-%d)
          git add mamae-review/backups/
          git diff --staged --quiet || git commit -m "üóÇÔ∏è Backup autom√°tico Firestore - $DATE"
          git push
      
      - name: Notificar sucesso
        if: success()
        run: echo "‚úÖ Backup conclu√≠do com sucesso!"
      
      - name: Notificar falha
        if: failure()
        run: echo "‚ùå Backup falhou! Verifique os logs."

